{% extends "base.html" %}

{% block title %}编辑Bug{% endblock %}

{% block content %}
<div class="layui-container">
        <div class="layui-card-header">编辑 #{{ bug.id }}</div>
        <div class="layui-card-body">
            <form class="layui-form" method="post" enctype="multipart/form-data">
                <div class="layui-form-item">
                    <label class="layui-form-label">标题</label>
                    <div class="layui-input-block">
                        <input type="text" name="title" required lay-verify="required" 
                               placeholder="请输入Bug标题" class="layui-input" 
                               value="{{ bug.title }}">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">描述</label>
                    <div class="layui-input-block">
                        <textarea name="description" required lay-verify="required" 
                                  placeholder="请详细描述Bug的表现、复现步骤等" 
                                  class="layui-textarea" style="height: 200px;">{{ bug.description }}</textarea>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">优先级</label>
                    <div class="layui-input-inline">
                        <select name="priority" required lay-verify="required">
                            <option value="">请选择优先级</option>
                            <option value="高" {% if bug.priority == '高' %}selected{% endif %}>高</option>
                            <option value="中" {% if bug.priority == '中' %}selected{% endif %}>中</option>
                            <option value="低" {% if bug.priority == '低' %}selected{% endif %}>低</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">状态</label>
                    <div class="layui-input-inline">
                        <select name="status" required lay-verify="required">
                            <option value="">请选择状态</option>
                            <option value="待处理" {% if bug.status == '待处理' %}selected{% endif %}>待处理</option>
                            <option value="处理中" {% if bug.status == '处理中' %}selected{% endif %}>处理中</option>
                            <option value="返回待补充" {% if bug.status == '返回待补充' %}selected{% endif %}>返回待补充</option>
                            <option value="更新完成" {% if bug.status == '更新完成' %}selected{% endif %}>更新完成</option>
                            <option value="已关闭" {% if bug.status == '已关闭' %}selected{% endif %}>已关闭</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">项目</label>
                    <div class="layui-input-inline">
                        <select name="project_id" required lay-verify="required">
                            <option value="">请选择项目</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}" {% if bug.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">类别</label>
                    <div class="layui-input-inline">
                        <select name="category" required lay-verify="required">
                            <option value="">请选择类别</option>
                            <option value="功能" {% if bug.category == '功能' %}selected{% endif %}>功能</option>
                            <option value="界面" {% if bug.category == '界面' %}selected{% endif %}>界面</option>
                            <option value="性能" {% if bug.category == '性能' %}selected{% endif %}>性能</option>
                            <option value="兼容性" {% if bug.category == '兼容性' %}selected{% endif %}>兼容性</option>
                            <option value="其他" {% if bug.category == '其他' %}selected{% endif %}>其他</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">类型</label>
                    <div class="layui-input-inline">
                        <select name="type" required lay-verify="required">
                            <option value="">请选择类型</option>
                            <option value="BUG" {% if bug.type == 'BUG' %}selected{% endif %}>BUG</option>
                            <option value="REQUIREMENT" {% if bug.type == 'REQUIREMENT' %}selected{% endif %}>需求</option>
                        </select>
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">现有附件</label>
                    <div class="layui-input-block">
                        {% if bug.attachments %}
                        <table class="layui-table">
                            <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>上传时间</th>
                                    <th>上传者</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attachment in bug.attachments %}
                                <tr>
                                    <td>{{ attachment.filename }}</td>
                                    <td>{{ attachment.get_file_size_display() }}</td>
                                    <td>{{ attachment.upload_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ attachment.uploader.username }}</td>
                                    <td>
                                        <div class="layui-btn-group">
                                            <a href="{{ url_for('bug.download_attachment', id=attachment.id) }}" 
                                               class="layui-btn layui-btn-xs">
                                                <i class="layui-icon layui-icon-download-circle"></i>下载
                                            </a>
                                            {% if attachment.is_previewable() %}
                                            <a href="{{ url_for('bug.preview_attachment', id=attachment.id) }}" 
                                               target="_blank" class="layui-btn layui-btn-xs layui-btn-normal">
                                                <i class="layui-icon layui-icon-eye"></i>预览
                                            </a>
                                            {% endif %}
                                            {% if current_user.is_admin or current_user.id == attachment.uploader_id or current_user.id == bug.creator_id %}
                                            <button type="button" onclick="deleteAttachment({{ attachment.id }})" 
                                                    class="layui-btn layui-btn-xs layui-btn-danger">
                                                <i class="layui-icon layui-icon-delete"></i>删除
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="layui-form-mid layui-word-aux">暂无附件</div>
                        {% endif %}
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">上传新附件</label>
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn" id="fileUpload">
                            <i class="layui-icon layui-icon-upload"></i> 选择文件
                        </button>
                        <div class="layui-upload-list">
                            <table class="layui-table">
                                <thead>
                                    <tr>
                                        <th>文件名</th>
                                        <th>大小</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="fileList"></tbody>
                            </table>
                        </div>
                        <div class="layui-form-mid layui-word-aux">
                            支持的文件类型：图片(jpg/png/webp)、文档(doc/pdf/txt)、压缩包(zip/rar)等<br>
                            单个文件大小限制：100MB
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit>保存</button>
                        <a href="{{ url_for('bug.detail', id=bug.id) }}" class="layui-btn layui-btn-primary">返回</a>
                    </div>
                </div>

                <!-- 删除附件的表单 -->
                <form id="deleteAttachmentForm" method="post" style="display: none;"></form>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
layui.use(['upload'], function(){
    var upload = layui.upload;
    
    // 文件选择功能
    upload.render({
        elem: '#fileUpload',
        url: '#',
        auto: false,
        accept: 'file',   
        multiple: false,
        bindAction: false,
        choose: function(obj){
            var files = obj.pushFile();
            
            // 预览选择的文件
            obj.preview(function(index, file, result){
                var tr = $(['<tr id="upload-'+ index +'">'
                    ,'<td>'+ file.name +'</td>'
                    ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
                    ,'<td>待上传</td>'
                    ,'<td>'
                    ,'<button type="button" class="layui-btn layui-btn-xs layui-btn-danger file-delete">删除</button>'
                    ,'</td>'
                    ,'</tr>'].join(''));
                
                // 删除按钮事件
                tr.find('.file-delete').on('click', function(){
                    delete files[index];
                    tr.remove();
                });
                
                // 创建隐藏的文件输入
                var input = $('<input type="file" name="files" style="display:none;">');
                var dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                input[0].files = dataTransfer.files;
                
                // 添加到表单
                $('form').append(input);
                
                $('#fileList').append(tr);
            });
        }
    });
});

form.on('submit()', function(data){
    return true;
});

function deleteAttachment(id) {
    layer.confirm('确定要删除这个附件吗？', {
        btn: ['确定','取消']
    }, function(){
        var form = document.getElementById('deleteAttachmentForm');
        form.action = '/bug/attachment/' + id + '/delete';
        form.submit();
    });
}
{% endblock %}